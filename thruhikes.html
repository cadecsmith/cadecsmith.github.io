<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>America's Thru Hikes</title>
    <style>
      html,
      body,
      arcgis-map {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>

    <script>
      var esriConfig = {
        apiKey:
          "AAPTxy8BH1VEsoebNVZXo8HurOebzkTpszUf3jPcaAcWB_mjpbUmjXahKpHcrW7h0XyXOvuAx1ZA21-xepqUGx8Y7_dERY77oiAe0FgVAQ1870uwEaWN_tDb8horcsKiehLNruG86meBa9L9ymoO_RHxNN0vNKZONuiwt-v9JfKj47B9qMIAy87bsvQE-FhzIrFvNMsYcsxZ5jGUi9Uiq2GWijKSVn9CN8WPOVAb8GFcTM4.AT1_VosA7KQb",
      };
    </script>

    <script
      type="module"
      src="https://js.arcgis.com/calcite-components/3.0.3/calcite.esm.js"
    ></script>
    <link rel="stylesheet" href="https://js.arcgis.com/4.32/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.32/"></script>
    <script
      type="module"
      src="https://js.arcgis.com/map-components/4.32/arcgis-map-components.esm.js"
    ></script>
  </head>
  <body>
    <div id="title">America's Thru Hikes</div>
    <div id="filter-panel">
      <!-- length Filter Section -->
      <div class="filter-section">
        <label for="lengthFilter">Minimum Length (miles):</label>
        <input type="number" id="lengthFilter" min="0" step="1" />
        <button onclick="applyFilter()">Filter</button>
        <button onclick="resetFilter()">Reset</button>
      </div>

      <!-- search section -->
      <div class="filter-section">
        <label for="searchInput">Search by Trail Name:</label>
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="Enter trail name..." list="trailsList" />
          <datalist id="trailsList"></datalist>
          <button onclick="searchTrail()">Search</button>
        </div>
      </div>
    </div>
    <div id="info-panel">
      <button id="close-button" onclick="closePanel()">âœ–</button>
      <h2 id="trail-title">Trail Name</h2>
      <p id="trail-length"><b>Length (Miles):</b></p>
      <p id="trail-description"></p>
      <button id="zoom-button">Zoom to Trail</button>
    </div>
    <arcgis-map basemap="arcgis/topographic" center="-98.5795, 39.8283" zoom="4.5">
      <arcgis-zoom position="top-right"></arcgis-zoom>
    </arcgis-map>
    <style>
      #title {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.8);
        padding: 8px 15px;
        font-size: 20px;
        font-weight: bold;
        border-radius: 5px;
        box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.3);
        z-index: 1000;
      }

      #filter-panel {
        position: absolute;
        top: 65px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        font-size: 14px;
        border-radius: 5px;
        box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        width: 270px;
      }

      .filter-section {
        margin-bottom: 10px;
      }

      .filter-section:last-child {
        margin-bottom: 0;
      }

      .search-container {
        display: flex;
        margin-top: 5px;
      }

      #searchInput {
        flex-grow: 1;
        margin-right: 5px;
      }

      input,
      button {
        padding: 5px;
      }

      #info-panel {
        position: absolute;
        top: 65px;
        right: -350px; /* H\hidden by default, now on right side */
        width: 300px;
        max-height: 60%; /* Not full height */
        background: rgba(255, 255, 255, 0.9);
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.3);
        transition: right 0.3s ease-in-out;
        z-index: 1000;
        overflow-y: auto;
        margin: 10px; /* Space around the panel */
      }

      #close-button {
        position: absolute;
        top: 10px;
        right: 10px;
        background: transparent;
        border: none;
        font-size: 18px;
        cursor: pointer;
      }

      #zoom-button {
        display: block;
        width: 100%;
        padding: 10px;
        background: #0079c1;
        color: white;
        border: none;
        text-align: center;
        cursor: pointer;
        margin-top: 10px;
      }

      #zoom-button:hover {
        background: #005a8d;
      }
    </style>
  </body>
  <script>
    require([
      "esri/layers/FeatureLayer",
      "esri/renderers/UniqueValueRenderer",
      "esri/symbols/SimpleLineSymbol",
      "esri/Color",
      "esri/Graphic",
    ], (FeatureLayer, UniqueValueRenderer, SimpleLineSymbol, Color, Graphic) => {
      const arcgisMap = document.querySelector("arcgis-map");
      let generalizedTrails;
      let detailedTrails;
      let activeLayer;
      let selectedFeature = null;
      let currentFilterValue = null;
      let trailsList = [];

      // Store trail total lengths
      let trailTotalLengths = {};

      // Scale threshold for switching between layers
      const scaleThreshold = 500000;

      arcgisMap.addEventListener("arcgisViewReadyChange", () => {
        // Create generalized feature layer (for zoomed out view)
        generalizedTrails = new FeatureLayer({
          url: "https://services.arcgis.com/FvF9MZKp3JWPrSkg/arcgis/rest/services/Trails_Generalized/FeatureServer/0",
          outFields: ["*"],
          displayFilterEnabled: false,
          visible: true,
        });

        // Create detailed feature layer (for zoomed in view)
        detailedTrails = new FeatureLayer({
          url: "https://services.arcgis.com/FvF9MZKp3JWPrSkg/arcgis/rest/services/Trails_Merged/FeatureServer/0",
          outFields: ["*"],
          displayFilterEnabled: false,
          visible: false,
        });

        // Set active layer based on initial scale
        activeLayer = arcgisMap.view.scale > scaleThreshold ? generalizedTrails : detailedTrails;
        updateLayerVisibility();

        // Calculate trail lengths (for the generalized trails)
        calculateTrailTotalLengths().then(() => {
          // Set up renderers for both layers
          setupRenderer(generalizedTrails);
          setupRenderer(detailedTrails);

          // Add both layers to the map
          arcgisMap.map.addMany([generalizedTrails, detailedTrails]);
        });

        // Disable default popup
        arcgisMap.view.popup.autoOpenEnabled = false;
        arcgisMap.view.popup.dockEnabled = false;

        // Add scale change event listener to switch between layers
        arcgisMap.view.watch("scale", function (newScale) {
          // Switch active layer based on scale
          activeLayer = newScale > scaleThreshold ? generalizedTrails : detailedTrails;
          updateLayerVisibility();

          // Apply existing filters to the newly active layer
          applyCurrentFilters();
        });

        // Add click event to the view
        arcgisMap.view.on("click", (event) => {
          arcgisMap.view.hitTest(event).then((response) => {
            const feature = response.results?.find(
              (result) =>
                result.graphic?.layer === generalizedTrails ||
                result.graphic?.layer === detailedTrails
            );

            if (feature) {
              const attributes = feature.graphic.attributes;
              const trailName = attributes.Name;

              // For generalized trails, use the calculated total length
              if (feature.graphic.layer === generalizedTrails && trailTotalLengths[trailName]) {
                attributes.Length_Miles = trailTotalLengths[trailName];
              }

              selectTrail(attributes, feature.graphic);
            }
          });
        });
      });

      // Function to calculate total trail lengths by grouping segments
      async function calculateTrailTotalLengths() {
        try {
          // Query all trails from the generalized layer
          const results = await generalizedTrails.queryFeatures({
            where: "1=1",
            outFields: ["Name", "Shape__Length"], // Assuming Shape__Length is in meters
            returnGeometry: false,
          });

          // Group by trail name and calculate total length
          const trailLengths = {};

          results.features.forEach((feature) => {
            const name = feature.attributes.Name;
            const segmentLength = feature.attributes.Shape__Length;

            if (!name || !segmentLength) return;

            if (!trailLengths[name]) {
              trailLengths[name] = 0;
            }

            trailLengths[name] += segmentLength;
          });

          // Convert from meters to miles (1 meter = 0.000621371 miles)
          for (const name in trailLengths) {
            trailTotalLengths[name] = parseFloat((trailLengths[name] * 0.000621371).toFixed(2));
          }

          console.log("Trail total lengths calculated:", trailTotalLengths);
        } catch (error) {
          console.error("Error calculating trail lengths:", error);
        }
      }

      // Function to update layer visibility based on active layer
      function updateLayerVisibility() {
        generalizedTrails.visible = activeLayer === generalizedTrails;
        detailedTrails.visible = activeLayer === detailedTrails;
      }

      // Function to apply current filters to the active layer
      function applyCurrentFilters() {
        if (selectedFeature) {
          // If a trail is selected, show only that trail
          const trailName = selectedFeature.Name;

          // For detailed trails, use server-side filtering
          detailedTrails.definitionExpression = `Name = '${trailName}'`;

          // For generalized trails, use server-side filtering
          generalizedTrails.definitionExpression = `Name = '${trailName}'`;
        } else if (currentFilterValue) {
          // For detailed trails, we can use server-side filtering directly
          detailedTrails.definitionExpression = `Length_Miles >= ${currentFilterValue}`;

          // For generalized trails, we need to filter based on our calculated totals
          // Get names of trails that meet the length criteria
          const qualifyingTrails = Object.keys(trailTotalLengths).filter(
            (name) => trailTotalLengths[name] >= currentFilterValue
          );

          if (qualifyingTrails.length > 0) {
            // Create a WHERE clause with all qualifying trail names
            const whereClause = qualifyingTrails.map((name) => `Name = '${name}'`).join(" OR ");
            generalizedTrails.definitionExpression = whereClause;
          } else {
            // No trails meet the criteria, show none
            generalizedTrails.definitionExpression = "1=0";
          }
        } else {
          // No filters
          generalizedTrails.definitionExpression = "";
          detailedTrails.definitionExpression = "";
        }
      }

      // Setup renderer for a layer
      function setupRenderer(layer) {
        // Query the layer to get all unique trail names
        layer
          .queryFeatures({
            where: "1=1",
            outFields: ["Name"],
            returnGeometry: false,
            returnDistinctValues: true,
          })
          .then(function (results) {
            // Create a unique value renderer
            const renderer = new UniqueValueRenderer({
              field: "Name",
              defaultSymbol: new SimpleLineSymbol({
                color: new Color("#666666"),
                width: "2px",
              }),
              uniqueValueInfos: [],
            });

            // Clear existing datalist for search autocomplete if this is the first layer processed
            const trailsDatalist = document.getElementById("trailsList");
            if (layer === generalizedTrails) {
              trailsDatalist.innerHTML = "";
              trailsList = [];
            }

            // Add unique value for each trail name
            results.features.forEach(function (feature) {
              const trailName = feature.attributes.Name;

              // Avoid duplicates
              if (trailsList.includes(trailName)) return;
              trailsList.push(trailName);

              const color = getColorForTrail(trailName);

              // Add to renderer
              renderer.uniqueValueInfos.push({
                value: trailName,
                symbol: new SimpleLineSymbol({
                  color: new Color(color),
                  width: "3px",
                }),
              });

              // Add to search datalist
              const option = document.createElement("option");
              option.value = trailName;
              trailsDatalist.appendChild(option);
            });

            // Sort trail names alphabetically for easier search
            trailsList.sort();

            // Apply renderer
            layer.renderer = renderer;
          });
      }

      // Function to get color for a trail (ensure consistent colors across layers)
      function getColorForTrail(trailName) {
        // Simple hash function to generate a color based on the trail name
        let hash = 0;
        for (let i = 0; i < trailName.length; i++) {
          hash = trailName.charCodeAt(i) + ((hash << 5) - hash);
        }

        // Convert to a color
        const hue = Math.abs(hash) % 360;
        return `hsl(${hue}, 70%, 45%)`;
      }

      // Centralized function to select a trail by attributes and graphic
      function selectTrail(attributes, graphic) {
        // Store selected feature with proper length
        selectedFeature = { ...attributes };

        // If from generalized layer, use the calculated total length if available
        if (graphic.layer === generalizedTrails && trailTotalLengths[attributes.Name]) {
          selectedFeature.Length_Miles = trailTotalLengths[attributes.Name];
        }

        // Update the side panel with feature information
        document.getElementById("trail-title").textContent = selectedFeature.Name;
        document.getElementById(
          "trail-length"
        ).innerHTML = `<b>Length (Miles):</b> ${selectedFeature.Length_Miles}`;
        document.getElementById("trail-description").textContent =
          selectedFeature.Description ||
          "This famous thru-hiking trail offers beautiful scenery and challenging terrain.";

        // Show the side panel
        document.getElementById("info-panel").style.right = "10px";

        // Set up zoom button functionality
        document.getElementById("zoom-button").onclick = () => zoomToFeature(graphic);

        // Filter to selected feature on both layers
        const trailName = selectedFeature.Name;
        generalizedTrails.definitionExpression = `Name = '${trailName}'`;
        detailedTrails.definitionExpression = `Name = '${trailName}'`;

        if (graphic) {
          zoomToFeature(graphic);
        }
      }

      // Function to search for a trail by name
      window.searchTrail = function () {
        const searchValue = document.getElementById("searchInput").value.trim();

        if (!searchValue) return;

        // Query the active feature layer for the specified trail
        activeLayer
          .queryFeatures({
            where: `UPPER(Name) LIKE UPPER('%${searchValue}%')`,
            outFields: ["*"],
            returnGeometry: true,
          })
          .then(function (results) {
            if (results.features.length > 0) {
              // Get the first matching trail
              const feature = results.features[0];
              const attributes = feature.attributes;

              // If from generalized layer, use the calculated total length
              if (activeLayer === generalizedTrails && trailTotalLengths[attributes.Name]) {
                attributes.Length_Miles = trailTotalLengths[attributes.Name];
              }

              // Select the trail
              selectTrail(attributes, feature);
            } else {
              alert("No trails found with that name. Please try again.");
            }
          })
          .catch(function (error) {
            console.error("Error searching for trail:", error);
          });
      };

      function zoomToFeature(graphic) {
        // Zoom to the selected feature with some padding
        if (graphic && graphic.geometry) {
          arcgisMap.view.goTo(
            {
              target: graphic.geometry,
              padding: { right: 350 }, // Account for the open side panel
            },
            {
              duration: 1000, // Animation duration in milliseconds
            }
          );
        }
      }

      window.closePanel = function () {
        document.getElementById("info-panel").style.right = "-350px";

        // Reset to previous length filter
        applyCurrentFilters();
        selectedFeature = null;
      };

      window.applyFilter = function () {
        const minLength = document.getElementById("lengthFilter").value;

        if (minLength) {
          currentFilterValue = parseFloat(minLength);
          applyCurrentFilters();
        }
      };

      window.resetFilter = function () {
        document.getElementById("lengthFilter").value = "";
        currentFilterValue = null;

        if (!selectedFeature) {
          generalizedTrails.definitionExpression = "";
          detailedTrails.definitionExpression = "";
        }
      };

      // Add enter key functionality to search input
      document.getElementById("searchInput").addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          window.searchTrail();
        }
      });
    });
  </script>
</html>
