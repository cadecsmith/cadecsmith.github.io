<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>America's Thru Hikes</title>
    <style>
      html,
      body,
      arcgis-map {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>

    <script>
      var esriConfig = {
        apiKey:
          "AAPTxy8BH1VEsoebNVZXo8HurOebzkTpszUf3jPcaAcWB_mjpbUmjXahKpHcrW7h0XyXOvuAx1ZA21-xepqUGx8Y7_dERY77oiAe0FgVAQ1870uwEaWN_tDb8horcsKiehLNruG86meBa9L9ymoO_RHxNN0vNKZONuiwt-v9JfKj47B9qMIAy87bsvQE-FhzIrFvNMsYcsxZ5jGUi9Uiq2GWijKSVn9CN8WPOVAb8GFcTM4.AT1_VosA7KQb",
      };
    </script>

    <script
      type="module"
      src="https://js.arcgis.com/calcite-components/3.0.3/calcite.esm.js"
    ></script>
    <link rel="stylesheet" href="https://js.arcgis.com/4.32/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.32/"></script>
    <script
      type="module"
      src="https://js.arcgis.com/map-components/4.32/arcgis-map-components.esm.js"
    ></script>
  </head>
  <body>
    <div id="title">America's Thru Hikes</div>
    <div id="filter-panel">
      <!-- length Filter Section -->
      <div class="filter-section">
        <label for="lengthFilter">Minimum Length (miles):</label>
        <input type="number" id="lengthFilter" min="0" step="1" />
        <button onclick="applyFilter()">Filter</button>
        <button onclick="resetFilter()">Reset</button>
      </div>

      <!-- search section -->
      <div class="filter-section">
        <label for="searchInput">Search by Trail Name:</label>
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="Enter trail name..." list="trailsList" />
          <datalist id="trailsList"></datalist>
          <button onclick="searchTrail()">Search</button>
        </div>
      </div>
    </div>
    <div id="info-panel">
      <button id="close-button" onclick="closePanel()">âœ–</button>
      <h2 id="trail-title">Trail Name</h2>
      <p id="trail-length"><b>Length (Miles):</b></p>
      <p id="trail-description"></p>
      <button id="zoom-button">Zoom to Trail</button>
    </div>
    <arcgis-map basemap="arcgis/topographic" center="-98.5795, 39.8283" zoom="4.5">
      <arcgis-zoom position="top-right"></arcgis-zoom>
    </arcgis-map>
    <style>
      #title {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.8);
        padding: 8px 15px;
        font-size: 20px;
        font-weight: bold;
        border-radius: 5px;
        box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.3);
        z-index: 1000;
      }

      #filter-panel {
        position: absolute;
        top: 65px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        font-size: 14px;
        border-radius: 5px;
        box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        width: 270px;
      }

      .filter-section {
        margin-bottom: 10px;
      }

      .filter-section:last-child {
        margin-bottom: 0;
      }

      .search-container {
        display: flex;
        margin-top: 5px;
      }

      #searchInput {
        flex-grow: 1;
        margin-right: 5px;
      }

      input,
      button {
        padding: 5px;
      }

      #info-panel {
        position: absolute;
        top: 65px;
        right: -350px; /* H\hidden by default, now on right side */
        width: 300px;
        max-height: 60%; /* Not full height */
        background: rgba(255, 255, 255, 0.9);
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.3);
        transition: right 0.3s ease-in-out;
        z-index: 1000;
        overflow-y: auto;
        margin: 10px; /* Space around the panel */
      }

      #close-button {
        position: absolute;
        top: 10px;
        right: 10px;
        background: transparent;
        border: none;
        font-size: 18px;
        cursor: pointer;
      }

      #zoom-button {
        display: block;
        width: 100%;
        padding: 10px;
        background: #0079c1;
        color: white;
        border: none;
        text-align: center;
        cursor: pointer;
        margin-top: 10px;
      }

      #zoom-button:hover {
        background: #005a8d;
      }
    </style>
  </body>
  <script>
    require([
      "esri/layers/FeatureLayer",
      "esri/renderers/UniqueValueRenderer",
      "esri/symbols/SimpleLineSymbol",
      "esri/Color",
    ], (FeatureLayer, UniqueValueRenderer, SimpleLineSymbol, Color) => {
      const arcgisMap = document.querySelector("arcgis-map");
      let detailedTrails;
      let generalizedTrails;
      let selectedFeature = null;
      let currentFilterValue = null;

      // Define scale threshold - starting with a higher value to ensure visibility
      const SCALE_THRESHOLD = 150000; // Increased from 50000

      // Trail colors array
      const trailColors = [
        "#e6194B",
        "#3cb44b",
        "#ffe119",
        "#4363d8",
        "#f58231",
        "#911eb4",
        "#42d4f4",
        "#f032e6",
        "#bfef45",
        "#fabebe",
      ];

      function getColorForTrail(trailName) {
        let hash = 0;
        for (let i = 0; i < trailName.length; i++) {
          hash = trailName.charCodeAt(i) + ((hash << 5) - hash);
        }
        return trailColors[Math.abs(hash) % trailColors.length];
      }

      arcgisMap.addEventListener("arcgisViewReadyChange", () => {
        console.log("Map view is ready");

        // Log the current scale to help with debugging
        console.log("Initial map scale:", arcgisMap.view.scale);

        // Create detailed trails layer
        detailedTrails = new FeatureLayer({
          url: "https://services.arcgis.com/FvF9MZKp3JWPrSkg/arcgis/rest/services/Trails_Merged/FeatureServer/0",
          outFields: ["*"],
          visible: true, // Ensure visibility is on
          title: "Detailed Trails",
        });

        // Create generalized trails layer
        generalizedTrails = new FeatureLayer({
          url: "https://services.arcgis.com/FvF9MZKp3JWPrSkg/arcgis/rest/services/Trails_Generalized/FeatureServer/0",
          outFields: ["*"],
          visible: true, // Ensure visibility is on
          title: "Generalized Trails",
        });

        // Add layers to map FIRST before setting up styling
        arcgisMap.map.addMany([generalizedTrails, detailedTrails]);
        console.log("Added layers to map");

        // Handle layer loading errors
        detailedTrails.when(
          () => {
            console.log("Detailed trails layer loaded successfully");
          },
          (error) => {
            console.error("Error loading detailed trails layer:", error);
          }
        );

        generalizedTrails.when(
          () => {
            console.log("Generalized trails layer loaded successfully");
          },
          (error) => {
            console.error("Error loading generalized trails layer:", error);
          }
        );

        // Now set up styling and scale-dependent visibility
        Promise.all([setupLayerStyling(detailedTrails), setupLayerStyling(generalizedTrails)])
          .then(() => {
            console.log("Layer styling complete");

            // NOW set scale-dependent visibility
            updateLayerVisibility(arcgisMap.view.scale);

            // Set up scale watcher
            arcgisMap.view.watch("scale", (newScale) => {
              console.log("Scale changed to:", newScale);
              updateLayerVisibility(newScale);
            });

            // Set up interaction events
            setupMapInteraction();
          })
          .catch((error) => {
            console.error("Error setting up layer styling:", error);
          });
      });

      // Function to update layer visibility based on scale
      function updateLayerVisibility(scale) {
        detailedTrails.visible = scale <= SCALE_THRESHOLD;
        generalizedTrails.visible = scale > SCALE_THRESHOLD;
        console.log(
          `Scale: ${scale}, Detailed visible: ${detailedTrails.visible}, Generalized visible: ${generalizedTrails.visible}`
        );
      }

      // Function to set up layer styling
      function setupLayerStyling(layer) {
        return new Promise((resolve, reject) => {
          // First check if the layer has loaded
          if (!layer.loaded) {
            console.log(`Layer ${layer.title} not yet loaded, waiting...`);
            layer.when(
              () => setupAndResolve(),
              (error) => reject(`Failed to load layer ${layer.title}: ${error}`)
            );
          } else {
            setupAndResolve();
          }

          function setupAndResolve() {
            // Query to get all unique trail names
            layer
              .queryFeatures({
                where: "1=1",
                outFields: ["Name"],
                returnGeometry: false,
                returnDistinctValues: true,
              })
              .then(function (results) {
                console.log(`Got ${results.features.length} unique trails for ${layer.title}`);

                // Create renderer
                const renderer = new UniqueValueRenderer({
                  field: "Name",
                  defaultSymbol: new SimpleLineSymbol({
                    color: new Color("#666666"),
                    width: "2px",
                  }),
                  uniqueValueInfos: [],
                });

                // If this is the detailed layer, build the legend
                if (layer === detailedTrails) {
                  const legendItems = document.getElementById("legend-items");
                  if (!legendItems) {
                    console.warn("Legend items container not found in DOM");
                  } else {
                    legendItems.innerHTML = ""; // Clear any existing items

                    // Create legend entries for each trail
                    const trailNames = [];
                    results.features.forEach(function (feature) {
                      const trailName = feature.attributes.Name;

                      // Skip duplicates
                      if (trailNames.includes(trailName)) return;
                      trailNames.push(trailName);

                      // Get color for this trail
                      const color = getColorForTrail(trailName);

                      // Add to renderer
                      renderer.uniqueValueInfos.push({
                        value: trailName,
                        symbol: new SimpleLineSymbol({
                          color: new Color(color),
                          width: "2px",
                        }),
                      });

                      // Add to legend UI
                      const legendItem = document.createElement("div");
                      legendItem.className = "legend-item";

                      const colorBox = document.createElement("div");
                      colorBox.className = "legend-color";
                      colorBox.style.backgroundColor = color;

                      const nameSpan = document.createElement("span");
                      nameSpan.textContent = trailName;

                      legendItem.appendChild(colorBox);
                      legendItem.appendChild(nameSpan);
                      legendItems.appendChild(legendItem);
                    });

                    // Show legend
                    const legendElement = document.getElementById("legend");
                    if (legendElement) {
                      legendElement.style.display = "block";
                    }
                  }
                }
                // For generalized layer, reuse the same color assignments
                else if (detailedTrails.renderer && detailedTrails.renderer.uniqueValueInfos) {
                  // Get existing renderer info from detailed layer
                  const detailedRendererInfo = detailedTrails.renderer.uniqueValueInfos;

                  // Apply same styles to generalized layer
                  detailedRendererInfo.forEach((info) => {
                    renderer.uniqueValueInfos.push(info);
                  });
                } else {
                  // If detailed layer renderer is not ready, create simple unique values
                  results.features.forEach(function (feature) {
                    const trailName = feature.attributes.Name;
                    const color = getColorForTrail(trailName);

                    renderer.uniqueValueInfos.push({
                      value: trailName,
                      symbol: new SimpleLineSymbol({
                        color: new Color(color),
                        width: "2px",
                      }),
                    });
                  });
                }

                // Apply renderer to layer
                layer.renderer = renderer;
                resolve();
              })
              .catch((error) => {
                console.error(`Error querying features for ${layer.title}:`, error);
                reject(error);
              });
          }
        });
      }

      // Function to set up map interaction
      function setupMapInteraction() {
        // Disable default popups
        arcgisMap.view.popup.autoOpenEnabled = false;

        // Add click event handler
        arcgisMap.view.on("click", (event) => {
          arcgisMap.view
            .hitTest(event)
            .then((response) => {
              // Determine which layer is currently visible
              const activeLayer =
                arcgisMap.view.scale <= SCALE_THRESHOLD ? detailedTrails : generalizedTrails;
              console.log("Active layer on click:", activeLayer.title);

              // Find if a trail was clicked
              const feature = response.results?.find(
                (result) => result.graphic?.layer === activeLayer
              );

              if (feature) {
                console.log("Trail clicked:", feature.graphic.attributes.Name);
                const attributes = feature.graphic.attributes;
                selectedFeature = attributes;

                // Update info panel with trail details
                const titleElement = document.getElementById("trail-title");
                const lengthElement = document.getElementById("trail-length");
                const descriptionElement = document.getElementById("trail-description");

                if (titleElement) titleElement.textContent = attributes.Name;
                if (lengthElement)
                  lengthElement.innerHTML = `<b>Length (Miles):</b> ${attributes.Length_Miles}`;
                if (descriptionElement)
                  descriptionElement.textContent =
                    attributes.Description ||
                    "This famous thru-hiking trail offers beautiful scenery and challenging terrain.";

                // Show info panel
                const infoPanel = document.getElementById("info-panel");
                if (infoPanel) infoPanel.style.right = "10px";

                // Set up zoom button
                const zoomButton = document.getElementById("zoom-button");
                if (zoomButton) {
                  zoomButton.onclick = () => zoomToFeature(feature.graphic);
                }

                // Filter both layers to show only selected trail
                filterToSelectedFeature(attributes.Name);

                // Zoom to trail
                zoomToFeature(feature.graphic);
              } else {
                console.log("No trail feature found at click location");
              }
            })
            .catch((error) => {
              console.error("Error in hit test:", error);
            });
        });
      }

      // Function to zoom to a trail
      function zoomToFeature(graphic) {
        if (graphic && graphic.geometry) {
          arcgisMap.view.goTo(
            {
              target: graphic.geometry,
              padding: { right: 350 }, // Space for info panel
            },
            { duration: 1000 } // Animation time
          );
        }
      }

      // Filter map to show only one trail on both layers
      function filterToSelectedFeature(trailName) {
        if (trailName) {
          // Save current filter value
          const filterElement = document.getElementById("lengthFilter");
          currentFilterValue = filterElement ? filterElement.value : null;

          // Apply filter to both layers
          const filterExpression = `Name = '${trailName}'`;
          detailedTrails.definitionExpression = filterExpression;
          generalizedTrails.definitionExpression = filterExpression;
          console.log("Applied filter for trail:", trailName);
        }
      }

      // Function to close info panel (called from HTML)
      window.closePanel = function () {
        // Hide panel
        const infoPanel = document.getElementById("info-panel");
        if (infoPanel) infoPanel.style.right = "-350px";

        // Restore previous filter to both layers
        if (currentFilterValue) {
          const filterExpression = `Length_Miles >= ${currentFilterValue}`;
          detailedTrails.definitionExpression = filterExpression;
          generalizedTrails.definitionExpression = filterExpression;
        } else {
          detailedTrails.definitionExpression = "";
          generalizedTrails.definitionExpression = "";
        }

        selectedFeature = null;
        console.log("Panel closed, filter reset");
      };

      // Function to apply length filter (called from HTML)
      window.applyFilter = function () {
        const filterElement = document.getElementById("lengthFilter");
        if (!filterElement) return;

        const minLength = filterElement.value;
        currentFilterValue = minLength;

        // Only apply if no trail selected
        if (!selectedFeature && minLength) {
          const filterExpression = `Length_Miles >= ${minLength}`;
          detailedTrails.definitionExpression = filterExpression;
          generalizedTrails.definitionExpression = filterExpression;
          console.log("Applied length filter:", minLength);
        }
      };

      // Function to reset filter (called from HTML)
      window.resetFilter = function () {
        // Only reset if no trail selected
        if (!selectedFeature) {
          detailedTrails.definitionExpression = "";
          generalizedTrails.definitionExpression = "";
        }

        const filterElement = document.getElementById("lengthFilter");
        if (filterElement) filterElement.value = "";
        currentFilterValue = null;
        console.log("Filter reset");
      };
    });
  </script>
</html>
